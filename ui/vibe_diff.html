<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Vibe Patch Diff UI</title>
  <style>
    html, body { margin: 0; height: 100%; overflow: hidden; }
    #toolbar {
      padding: 8px; background: #f3f3f3; border-bottom: 1px solid #ccc;
    }
    #toolbar button { margin-right: 6px; }
    #diff { height: calc(100% - 42px); }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.47.0/min/vs/loader.js"></script>
</head>
<body>
  <div id="toolbar">
    <button id="loadFileBtn">Load File</button>
    <button id="loadPatchBtn" disabled>Load Patch</button>
    <button id="acceptBtn" disabled>Accept</button>
    <input type="file" id="fileInput1" accept=".py" style="display:none">
    <input type="file" id="fileInput2" accept=".vibe,.txt" style="display:none">
  </div>
  <div id="diff"></div>

  <script>
    require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.47.0/min/vs' }});
    require(['vs/editor/editor.main'], () => {
      const diffEditor = monaco.editor.createDiffEditor(
        document.getElementById('diff'),
        { readOnly: true, renderSideBySide: true }
      );

      const loadFileBtn  = document.getElementById('loadFileBtn');
      const loadPatchBtn = document.getElementById('loadPatchBtn');
      const acceptBtn    = document.getElementById('acceptBtn');
      const fileInput1   = document.getElementById('fileInput1');
      const fileInput2   = document.getElementById('fileInput2');

      let origText    = '';
      let patchText   = '';
      let patchedText = '';
      let currentFile = '';

      // Step 1: Load the Python file
      loadFileBtn.onclick = () => fileInput1.click();
      fileInput1.onchange = async e => {
        const f = e.target.files[0];
        if (!f) return;
        origText = await f.text();
        currentFile = f.name;
        // show no-diff initially
        const model = monaco.editor.createModel(origText, 'python');
        diffEditor.setModel({ original: model, modified: model });
        // enable patch loading
        loadPatchBtn.disabled = false;
        acceptBtn.disabled    = true;
      };

      // Step 2: Load the patch and immediately preview
      loadPatchBtn.onclick = () => fileInput2.click();
      fileInput2.onchange = async e => {
        const f = e.target.files[0];
        if (!f) return alert('Please select a .vibe patch file.');
        patchText = await f.text();

        // POST to /apply
        const resp = await fetch('/apply', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ patch: patchText })
        });
        if (!resp.ok) {
          alert('Apply failed: ' + resp.statusText);
          return;
        }

        const results = await resp.json();
        // pick the patched text for the file we loaded
        patchedText = results[currentFile] || results[Object.keys(results)[0]];
        if (patchedText === undefined) {
          alert(`No patched output for "${currentFile}".`);
          return;
        }

        // show the diff
        const origModel = monaco.editor.createModel(origText, 'python');
        const modModel  = monaco.editor.createModel(patchedText, 'python');
        diffEditor.setModel({ original: origModel, modified: modModel });

        // enable Accept button
        acceptBtn.disabled = false;
      };

      // Step 3: Accept = write it back via /save
      acceptBtn.onclick = async () => {
        const resp = await fetch('/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ patch: patchText })
        });
        if (!resp.ok) {
          alert('Save failed: ' + resp.statusText);
          return;
        }
        // commit the patch locally in the UI
        origText = patchedText;
        acceptBtn.disabled = true;
        loadPatchBtn.disabled = true;
        // show no-diff (the patched text is now the "original")
        const model = monaco.editor.createModel(origText, 'python');
        diffEditor.setModel({ original: model, modified: model });
      };
    });
  </script>
</body>
</html>
