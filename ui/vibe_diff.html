<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Vibe Patch Diff UI</title>
  <style>
    html, body { margin: 0; height: 100%; overflow: hidden; }
    body        { display: flex; flex-direction: column; }
    #toolbar    { display: flex; align-items: center; gap: 6px; padding: 8px; background: #add8e6; border-bottom: 1px solid #ccc; }
    #versionDisplay { margin-left: auto; font-style: italic; }

    /* main area: diff + dragH + patchContainer */
    #main          { flex: 1 1 auto; display:flex; flex-direction:column; overflow:hidden; }
    #diff          { flex: 1 1 auto; overflow:hidden; }
    #dragH         { flex: 0 0 5px; background:#ccc; cursor:row-resize; }

    /* patch area row */
    #patchContainer { flex: 0 0 150px; display:flex; border-top:1px solid #ccc; }
    #patchBtns      { flex: 0 0 100px; display:flex; flex-direction:column; gap:4px; padding:4px; box-sizing:border-box; background:#f4f4f4; }
    #patchBtns button{ width:100%; height:32px; cursor:pointer; }
    #dragV          { flex:0 0 4px; background:#ccc; cursor:col-resize; }
    #patchArea      { flex:1 1 auto; width:100%; height:100%; box-sizing:border-box; font-family: monospace; padding: 8px; border:none; resize:none; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.47.0/min/vs/loader.js"></script>
</head>
<body>
  <div id="toolbar">
    <button id="loadFileBtn">Load File</button>
    <button id="loadPatchBtn" disabled>Load Patch</button>
    <button id="acceptBtn" disabled>Accept</button>
    <button id="prevBtn" disabled>Previous</button>
    <button id="nextBtn" disabled>Next</button>
    <div id="versionDisplay">Head</div>
    <input type="file" id="fileInput1" accept=".py"  style="display:none" />
    <input type="file" id="fileInput2" accept=".vibe,.txt" style="display:none" />
  </div>

  <div id="main">
    <div id="diff"></div>
    <div id="dragH"></div>
    <div id="patchContainer">
      <div id="patchBtns">
        <button id="clearPatchBtn"  title="Clear patch">Clear</button>
        <button id="applyPatchBtn"  title="Preview patch" disabled>Apply</button>
      </div>
      <div id="dragV"></div>
      <textarea id="patchArea" placeholder="Paste your .vibe patch here..."></textarea>
    </div>
  </div>

  <script>
    require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.47.0/min/vs' }});
    require(['vs/editor/editor.main'], () => {
      //------------------------------------------------------------------
      // DOM refs
      //------------------------------------------------------------------
      const qs = id => document.getElementById(id);
      const diffDom = qs('diff');
      const diffEditor = monaco.editor.createDiffEditor(diffDom, {
        readOnly: true,
        renderSideBySide: true,
        enableSplitViewResizing: true  // vertical divider inside Monaco is draggable
      });

      const loadFileBtn  = qs('loadFileBtn');
      const loadPatchBtn = qs('loadPatchBtn');
      const acceptBtn    = qs('acceptBtn');
      const prevBtn      = qs('prevBtn');
      const nextBtn      = qs('nextBtn');
      const clearBtn     = qs('clearPatchBtn');
      const applyBtn     = qs('applyPatchBtn');
      const versionDisplay = qs('versionDisplay');
      const fileInput1   = qs('fileInput1');
      const fileInput2   = qs('fileInput2');
      const patchArea    = qs('patchArea');
      const dragH        = qs('dragH');
      const dragV        = qs('dragV');
      const patchContainer = qs('patchContainer');
      const patchBtns    = qs('patchBtns');

      //------------------------------------------------------------------
      // State vars (unchanged parts collapsed)
      //------------------------------------------------------------------
      let headText='', compareText='', patchText='', currentFile='';
      let versions=[], versionIndex=0, previewActive=false;
      const setDiff = (orig, mod) => {
        diffEditor.setModel({
          original: monaco.editor.createModel(orig, 'python'),
          modified: monaco.editor.createModel(mod,  'python')
        });
      };
      const toast = m=>{console.error(m);alert(m);};

      //------------------------------------------------------------------
      // DRAGÂ HANDLES -----------------------------------------------------
      //------------------------------------------------------------------
      // Horizontal drag (height of patch container)
      (()=>{
        let startY, startHeight;
        dragH.addEventListener('mousedown', e=>{
          startY = e.clientY;
          startHeight = patchContainer.getBoundingClientRect().height;
          document.body.style.cursor='row-resize';
          window.addEventListener('mousemove', onMove);
          window.addEventListener('mouseup', onUp);
        });
        function onMove(ev){
          const dy = ev.clientY - startY;
          const newH = Math.max(80, startHeight - dy);
          patchContainer.style.flexBasis = newH + 'px';
        }
        function onUp(){
          document.body.style.cursor='';
          window.removeEventListener('mousemove', onMove);
          window.removeEventListener('mouseup', onUp);
        }
      })();

      // Vertical drag (width of buttons strip)
      (()=>{
        let startX, startW;
        dragV.addEventListener('mousedown', e=>{
          startX = e.clientX;
          startW = patchBtns.getBoundingClientRect().width;
          document.body.style.cursor='col-resize';
          window.addEventListener('mousemove', onMove);
          window.addEventListener('mouseup', onUp);
        });
        function onMove(ev){
          const dx = ev.clientX - startX;
          const newW = Math.max(60, startW + dx);
          patchBtns.style.flexBasis = newW + 'px';
        }
        function onUp(){
          document.body.style.cursor='';
          window.removeEventListener('mousemove', onMove);
          window.removeEventListener('mouseup', onUp);
        }
      })();

      //------------------------------------------------------------------
      // (Rest of JS logic unchanged from previous version)
      //------------------------------------------------------------------
      function updateNav(){
        prevBtn.disabled=!(previewActive||versionIndex>0);
        nextBtn.disabled=!(!previewActive&&versionIndex<versions.length);
        acceptBtn.disabled=(compareText===headText);
        clearBtn.disabled=applyBtn.disabled=!patchText.trim();
        versionDisplay.textContent=previewActive?'Preview':(versionIndex===versions.length?'Head':(versions[versionIndex]?.sha||'Head'));
      }
      async function fetchVersions(){try{const r=await fetch(`/versions?file=${encodeURIComponent(currentFile)}`);versions=r.ok?await r.json():[]}catch{versions=[]}versionIndex=versions.length;updateNav();}
      async function loadHead(){const r=await fetch(`/file?file=${encodeURIComponent(currentFile)}`);if(!r.ok)return toast('Failed to load current file');headText=compareText=await r.text();setDiff(headText,headText);versionIndex=versions.length;previewActive=false;updateNav();}
      async function loadVersion(i){if(i===versions.length)return loadHead();const sha=versions[i].sha;const r=await fetch(`/version?file=${encodeURIComponent(currentFile)}&sha=${encodeURIComponent(sha)}`);if(!r.ok)return toast('Failed to load version');compareText=await r.text();setDiff(headText,compareText);versionIndex=i;previewActive=false;updateNav();}
      async function previewPatch(){if(!patchText.trim()){previewActive=false;compareText=headText;setDiff(headText,headText);updateNav();return;}try{const r=await fetch('/apply',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({patch:patchText})});if(!r.ok)throw new Error(await r.text());const res=await r.json();compareText=res[currentFile]||res[Object.keys(res)[0]];setDiff(headText,compareText);previewActive=true;updateNav();}catch(e){toast('Preview failed: '+e.message);} }
      // launch
      patchArea.value='';updateNav();
      loadFileBtn.onclick=()=>fileInput1.click();fileInput1.onchange=async e=>{const f=e.target.files[0];if(!f)return;headText=compareText=await f.text();currentFile=f.name;setDiff(headText,headText);loadPatchBtn.disabled=false;patchArea.value=patchText='';previewActive=false;await fetchVersions();};
      loadPatchBtn.onclick=()=>fileInput2.click();fileInput2.onchange=async e=>{const f=e.target.files[0];if(!f)return;patchArea.value=patchText=await f.text();applyBtn.disabled=false;await previewPatch();};
      clearBtn.onclick=()=>{patchArea.value=patchText='';previewActive=false;compareText=headText;setDiff(headText,headText);updateNav();patchArea.focus();};
      applyBtn.onclick=()=>{patchText=patchArea.value;previewPatch();};
      patchArea.addEventListener('input',()=>{patchText=patchArea.value;updateNav();});
      patchArea.addEventListener('paste',async e=>{e.preventDefault();const txt=(e.clipboardData||window.clipboardData).getData('text');patchArea.value=patchText=txt;applyBtn.disabled=false;await previewPatch();});
      prevBtn.onclick=()=>{if(previewActive)clearBtn.click();else if(versionIndex>0)loadVersion(versionIndex-1);};
      nextBtn.onclick=()=>{if(!previewActive&&versionIndex<versions.length)loadVersion(versionIndex+1);};
      acceptBtn.onclick=async()=>{try{const right=diffEditor.getModifiedEditor().getModel().getValue();const r=await fetch('/accept_changes',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({file:currentFile,text:right})});if(!r.ok)throw new Error(await r.text());headText=compareText=right;patchArea.value=patchText='';previewActive=false;setDiff(headText,headText);await fetchVersions();}catch(e){toast('Accept failed: '+e.message);}};
    });
  </script>
</body>
</html>
